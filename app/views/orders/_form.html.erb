<%= form_with(model: order, html: { class: "space-y-8" }) do |f| %>
  <% if order.errors.any? %>
    <div class="rounded-lg border border-red-200 bg-red-50 p-4 text-sm text-red-800">
      <h2 class="font-semibold"><%= pluralize(order.errors.count, "error") %> prevented this order from saving:</h2>
      <ul class="mt-2 list-disc pl-5">
        <% order.errors.full_messages.each do |msg| %>
          <li><%= msg %></li>
        <% end %>
      </ul>
    </div>
  <% end %>

  <div class="grid grid-cols-1 gap-6 md:grid-cols-2">
    <div>
      <%= f.label :customer_id, "Customer", class: "text-sm font-medium text-gray-700" %>
      <%= f.collection_select :customer_id, Customer.order(:display_name), :id, :display_name,
        { include_blank: "Select customer" },
        class: "mt-1 block w-full rounded-lg border border-gray-300 bg-white px-3 py-2 text-sm text-gray-900 shadow-sm focus:border-gray-900 focus:ring-2 focus:ring-gray-900/20" %>
      <%= link_to "+ Add customer",
        new_customer_path,
        data: { turbo_frame: "customer_modal" },
        class: "mt-2 inline-flex text-sm font-medium text-emerald-600 hover:text-emerald-500" %>
    </div>

    <div>
      <%= f.label :location_id, "Location", class: "text-sm font-medium text-gray-700" %>
      <%= f.collection_select :location_id, Location.order(:label), :id, :label,
        { include_blank: "Select location" },
        class: "mt-1 block w-full rounded-lg border border-gray-300 bg-white px-3 py-2 text-sm text-gray-900 shadow-sm focus:border-gray-900 focus:ring-2 focus:ring-gray-900/20" %>
    </div>

    <div>
      <%= f.label :external_reference, "Internal ref / PO #", class: "text-sm font-medium text-gray-700" %>
      <%= f.text_field :external_reference,
        class: "mt-1 block w-full rounded-lg border border-gray-300 bg-white px-3 py-2 text-sm text-gray-900 shadow-sm focus:border-gray-900 focus:ring-2 focus:ring-gray-900/20" %>
    </div>

    <div>
      <%= f.label :status, class: "text-sm font-medium text-gray-700" %>
      <%= f.select :status, Order::STATUSES,
        {},
        class: "mt-1 block w-full rounded-lg border border-gray-300 bg-white px-3 py-2 text-sm text-gray-900 shadow-sm focus:border-gray-900 focus:ring-2 focus:ring-gray-900/20" %>
    </div>

    <div>
      <%= f.label :start_date, class: "text-sm font-medium text-gray-700" %>
      <%= f.date_field :start_date,
        class: "mt-1 block w-full rounded-lg border border-gray-300 bg-white px-3 py-2 text-sm text-gray-900 shadow-sm focus:border-gray-900 focus:ring-2 focus:ring-gray-900/20" %>
    </div>

    <div>
      <%= f.label :end_date, class: "text-sm font-medium text-gray-700" %>
      <%= f.date_field :end_date,
        class: "mt-1 block w-full rounded-lg border border-gray-300 bg-white px-3 py-2 text-sm text-gray-900 shadow-sm focus:border-gray-900 focus:ring-2 focus:ring-gray-900/20" %>
    </div>
  </div>

  <% unit_types = @unit_types || (order.company ? order.company.unit_types.order(:name) : UnitType.none) %>
  <% unit_type_payload = unit_types.map { |ut| { id: ut.id, name: ut.name } } %>
  <% unit_type_payload_json = json_escape(unit_type_payload.to_json) %>
  <% existing_line_items_payload = order.order_line_items.map do |li|
       {
         unit_type_id: li.unit_type_id,
         rate_plan_id: li.rate_plan_id,
         quantity: li.quantity
       }
     end %>
  <% required_rate_plan_ids = existing_line_items_payload.map { |li| li[:rate_plan_id] }.compact %>
  <% active_rate_plans = RatePlan.active.includes(:unit_type).to_a %>
  <% missing_rate_plans = if required_rate_plan_ids.any?
       missing = required_rate_plan_ids - active_rate_plans.map(&:id)
       missing.any? ? RatePlan.includes(:unit_type).where(id: missing).to_a : []
     else
       []
     end %>
  <% rate_plans_for_view = (active_rate_plans + missing_rate_plans).uniq { |rp| rp.id } %>
  <% rate_plan_payload = rate_plans_for_view.group_by(&:unit_type_id).transform_values do |plans|
       plans.sort_by { |plan| [ plan.billing_period.to_s, plan.service_schedule.to_s ] }.map do |plan|
         price = number_to_currency(plan.price_cents.to_i / 100.0)
         schedule_label = plan.service_schedule.to_s.humanize.presence || "Service schedule"
         billing_label = plan.billing_period.to_s.humanize.presence || "Billing period"
         label = "#{schedule_label} (#{billing_label}) â€¢ #{price}"
         { id: plan.id, label: label }
       end
     end %>
  <% rate_plan_payload_json = json_escape(rate_plan_payload.to_json) %>
  <% existing_line_items_payload_json = json_escape(existing_line_items_payload.to_json) %>

  <div class="space-y-4">
    <div>
      <h2 class="text-lg font-semibold text-gray-900">Line items</h2>
      <p class="text-sm text-gray-600">Add each unit type, quantity, and rate plan combination you need.</p>
    </div>

    <% option_tags = options_from_collection_for_select(unit_types, :id, :name) %>

    <%= tag.div class: "space-y-4",
      data: {
        controller: "order-items",
        order_items_unit_types_value: unit_type_payload_json,
        order_items_rate_plans_value: rate_plan_payload_json,
        order_items_existing_value: existing_line_items_payload_json
      } do %>
      <div class="space-y-3" data-order-items-target="rows"></div>
      <p class="text-sm text-gray-500" data-order-items-target="emptyState">No line items yet. Add at least one to continue.</p>

      <div class="mt-2">
        <button
          type="button"
          class="inline-flex items-center rounded-lg border border-gray-300 px-4 py-2 text-sm font-semibold text-gray-700 hover:bg-gray-50"
          data-order-items-target="addButton"
          data-action="order-items#showForm">
          Add item
        </button>
      </div>

      <div
        class="rounded-2xl border border-gray-200 bg-white p-4 shadow-sm"
        data-order-items-target="form"
        hidden>
        <div class="grid gap-4 md:grid-cols-3">
          <div>
            <label class="text-xs font-medium text-gray-700">Unit type</label>
            <select
              class="mt-1 block w-full rounded-lg border border-gray-300 bg-white px-3 py-2 text-sm text-gray-900 shadow-sm focus:border-gray-900 focus:ring-2 focus:ring-gray-900/20"
              data-order-items-target="unitType"
              data-action="change->order-items#unitTypeChanged">
              <option value="">Select unit type</option>
              <%= option_tags %>
            </select>
          </div>

          <div>
            <label class="text-xs font-medium text-gray-700">Quantity</label>
            <%= tag.input type: "number",
              min: 1,
              step: 1,
              value: 1,
              class: "mt-1 block w-full rounded-lg border border-gray-300 bg-white px-3 py-2 text-sm text-gray-900 shadow-sm focus:border-gray-900 focus:ring-2 focus:ring-gray-900/20",
              data: { order_items_target: "quantity" } %>
          </div>

          <div>
            <label class="text-xs font-medium text-gray-700">Rate plan</label>
            <%= tag.select class: "mt-1 block w-full rounded-lg border border-gray-300 bg-white px-3 py-2 text-sm text-gray-900 shadow-sm focus:border-gray-900 focus:ring-2 focus:ring-gray-900/20",
              data: { order_items_target: "ratePlan" } do %>
              <option value="">Select rate plan</option>
            <% end %>
          </div>
        </div>

        <p class="mt-2 text-sm text-red-600 hidden" data-order-items-target="error"></p>

        <div class="mt-4 flex justify-end gap-3">
          <button
            type="button"
            class="inline-flex items-center rounded-lg bg-white px-4 py-2 text-sm font-semibold text-gray-700 ring-1 ring-inset ring-gray-300 hover:bg-gray-50"
            data-action="order-items#cancelForm">
            Cancel
          </button>
          <button
            type="button"
            class="inline-flex items-center rounded-lg bg-gray-900 px-4 py-2 text-sm font-semibold text-white hover:bg-gray-800"
            data-action="order-items#addItem">
            Add item
          </button>
        </div>
      </div>

      <template data-order-items-target="rowTemplate">
        <div class="flex items-center justify-between rounded-2xl border border-gray-200 bg-white px-4 py-3 shadow-sm" data-role="row">
          <div>
            <p class="text-sm font-semibold text-gray-900" data-role="summary"></p>
            <p class="text-xs text-gray-500" data-role="details"></p>
          </div>
          <div class="flex items-center gap-4">
            <span class="text-sm font-medium text-gray-900" data-role="quantity"></span>
            <button type="button" class="text-sm font-medium text-rose-600 hover:text-rose-500" data-action="order-items#removeRow">
              Remove
            </button>
          </div>
          <input type="hidden" data-role="unitTypeInput" />
          <input type="hidden" data-role="ratePlanInput" />
          <input type="hidden" data-role="quantityInput" />
        </div>
      </template>
    <% end %>
  </div>

  <div>
    <%= f.label :notes, class: "text-sm font-medium text-gray-700" %>
    <%= f.text_area :notes,
      rows: 4,
      class: "mt-1 block w-full rounded-lg border border-gray-300 bg-white px-3 py-2 text-sm text-gray-900 shadow-sm focus:border-gray-900 focus:ring-2 focus:ring-gray-900/20" %>
  </div>

  <div class="flex justify-end">
    <%= f.submit "Save order",
      class: "inline-flex items-center rounded-lg bg-gray-900 px-4 py-2 text-sm font-semibold text-white hover:bg-gray-800" %>
  </div>
<% end %>

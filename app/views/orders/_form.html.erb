<%= form_with(
      model: order,
      data: {
        controller: "order-form",
        order_form_location_url_value: new_location_path,
        order_form_availability_url_value: availability_orders_path
      },
      html: { class: "space-y-8" }
    ) do |f| %>
  <% if order.errors.any? %>
    <div class="rounded-lg border border-red-200 bg-red-50 p-4 text-sm text-red-800">
      <h2 class="font-semibold"><%= pluralize(order.errors.count, "error") %> prevented this order from saving:</h2>
      <ul class="mt-2 list-disc pl-5">
        <% order.errors.full_messages.each do |msg| %>
          <li><%= msg %></li>
        <% end %>
      </ul>
    </div>
  <% end %>

  <div class="lg:grid lg:grid-cols-[minmax(0,2fr)_minmax(280px,1fr)] lg:gap-6">
    <div class="space-y-8">
      <div class="grid grid-cols-1 gap-6 md:grid-cols-2">
        <div>
          <%= f.label :customer_id, "Customer", class: "text-sm font-medium text-gray-700" %>
          <% customers = @customers || Customer.none %>
          <%= f.collection_select :customer_id, customers, :id, :display_name,
            { include_blank: "Select customer" },
            {
              class: "mt-1 block w-full rounded-lg border border-gray-300 bg-white px-3 py-2 text-sm text-gray-900 shadow-sm focus:border-gray-900 focus:ring-2 focus:ring-gray-900/20",
              data: { order_form_target: "customer", action: "change->order-form#customerChanged" }
            } %>
          <%= link_to "+ Add customer",
            new_customer_path,
            data: { turbo_frame: "customer_modal" },
            class: "mt-2 inline-flex text-sm font-medium text-emerald-600 hover:text-emerald-500" %>
        </div>

        <div>
          <%= f.label :location_id, "Location", class: "text-sm font-medium text-gray-700" %>
          <% locations = @locations || Location.none %>
          <%= f.collection_select :location_id, locations, :id, :display_label,
            { include_blank: "Select location" },
            {
              class: "mt-1 block w-full rounded-lg border border-gray-300 bg-white px-3 py-2 text-sm text-gray-900 shadow-sm focus:border-gray-900 focus:ring-2 focus:ring-gray-900/20",
              data: { order_form_target: "location" },
              disabled: order.customer_id.blank?
            } %>
          <% location_link_href = order.customer_id.present? ? new_location_path(customer_id: order.customer_id) : new_location_path %>
          <%= link_to "+ Add location",
            location_link_href,
            data: { order_form_target: "locationLink" },
            class: "mt-2 inline-flex text-sm font-medium text-emerald-600 hover:text-emerald-500 transition" %>
        </div>

        <div>
          <%= f.label :external_reference, "Internal ref / PO #", class: "text-sm font-medium text-gray-700" %>
          <%= f.text_field :external_reference,
            class: "mt-1 block w-full rounded-lg border border-gray-300 bg-white px-3 py-2 text-sm text-gray-900 shadow-sm focus:border-gray-900 focus:ring-2 focus:ring-gray-900/20" %>
        </div>

        <div>
          <%= f.label :status, class: "text-sm font-medium text-gray-700" %>
          <%= f.select :status, Order::STATUSES,
            {},
            class: "mt-1 block w-full rounded-lg border border-gray-300 bg-white px-3 py-2 text-sm text-gray-900 shadow-sm focus:border-gray-900 focus:ring-2 focus:ring-gray-900/20" %>
        </div>

        <div>
          <%= f.label :start_date, class: "text-sm font-medium text-gray-700" %>
          <%= f.date_field :start_date,
            class: "mt-1 block w-full rounded-lg border border-gray-300 bg-white px-3 py-2 text-sm text-gray-900 shadow-sm focus:border-gray-900 focus:ring-2 focus:ring-gray-900/20",
            data: { order_form_target: "startDate", action: "change->order-form#datesChanged input->order-form#datesChanged" } %>
        </div>

        <div>
          <%= f.label :end_date, class: "text-sm font-medium text-gray-700" %>
          <%= f.date_field :end_date,
            class: "mt-1 block w-full rounded-lg border border-gray-300 bg-white px-3 py-2 text-sm text-gray-900 shadow-sm focus:border-gray-900 focus:ring-2 focus:ring-gray-900/20",
            data: { order_form_target: "endDate", action: "change->order-form#datesChanged input->order-form#datesChanged" } %>
        </div>
      </div>

      <% payload = @order_form_payload || {} %>
      <% unit_types = payload[:unit_types] || [] %>
      <% unit_type_payload_json = payload[:unit_type_payload_json] || '[]' %>
      <% existing_line_items_payload_json = payload[:existing_line_items_payload_json] || '[]' %>
      <% rate_plan_payload_json = payload[:rate_plan_payload_json] || '{}' %>
      <% service_items_payload_json = payload[:service_items_payload_json] || '[]' %>
      <% service_rate_plans_payload_json = payload[:service_rate_plans_payload_json] || '[]' %>

      <div class="space-y-4">
        <div>
          <h2 class="text-lg font-semibold text-gray-900">Line items</h2>
          <p class="text-sm text-gray-600">Add each unit type, quantity, and rate plan combination you need.</p>
        </div>

        <% option_tags = options_from_collection_for_select(unit_types, :id, :name) %>

        <%= tag.div class: "space-y-4",
      data: {
        controller: "order-items",
        order_items_unit_types_value: unit_type_payload_json,
        order_items_rate_plans_value: rate_plan_payload_json,
        order_items_existing_value: existing_line_items_payload_json,
        order_items_service_existing_value: service_items_payload_json,
        order_items_new_rate_plan_url_value: new_rate_plan_path,
        order_items_service_rate_plans_value: service_rate_plans_payload_json
      } do %>
      <div class="space-y-3" data-order-items-target="rows"></div>
      <p class="text-sm text-gray-500" data-order-items-target="emptyState">No line items yet. Add at least one to continue.</p>

      <div class="mt-2">
        <button
          type="button"
          class="inline-flex items-center rounded-lg border border-gray-300 px-4 py-2 text-sm font-semibold text-gray-700 hover:bg-gray-50"
          data-order-items-target="addButton"
          data-action="order-items#showForm">
          Add item
        </button>
      </div>

      <div
        class="rounded-2xl border border-gray-200 bg-white p-4 shadow-sm"
        data-order-items-target="form"
        hidden>
        <div class="grid gap-4 md:grid-cols-3">
          <div>
            <label class="text-xs font-medium text-gray-700">Unit type</label>
            <select
              class="mt-1 block w-full rounded-lg border border-gray-300 bg-white px-3 py-2 text-sm text-gray-900 shadow-sm focus:border-gray-900 focus:ring-2 focus:ring-gray-900/20"
              data-order-items-target="unitType"
              data-action="change->order-items#unitTypeChanged">
              <option value="">Select unit type</option>
              <option value="service-only">Service-only (customer-owned units)</option>
              <%= option_tags %>
            </select>
          </div>

          <div>
            <label class="text-xs font-medium text-gray-700" data-order-items-target="quantityLabel">Quantity</label>
            <%= tag.input type: "number",
              min: 1,
              step: 1,
              value: 1,
              class: "mt-1 block w-full rounded-lg border border-gray-300 bg-white px-3 py-2 text-sm text-gray-900 shadow-sm focus:border-gray-900 focus:ring-2 focus:ring-gray-900/20",
              data: { order_items_target: "quantity" } %>
          </div>

          <div class="md:col-span-3" data-order-items-target="descriptionWrapper" hidden>
            <label class="text-xs font-medium text-gray-700">Description of service work</label>
            <input type="text"
              class="mt-1 block w-full rounded-lg border border-gray-300 bg-white px-3 py-2 text-sm text-gray-900 shadow-sm focus:border-gray-900 focus:ring-2 focus:ring-gray-900/20"
              data-order-items-target="description" placeholder="e.g. Service customer-owned ADA fleet" />
          </div>

          <div>
            <div class="flex items-center justify-between">
              <label class="text-xs font-medium text-gray-700">Rate plan</label>
              <button
                type="button"
                class="text-xs font-medium text-emerald-600 hover:text-emerald-500 transition"
                data-order-items-target="ratePlanLink"
                data-action="order-items#openRatePlanModal">
                + Add rate plan
              </button>
            </div>
            <%= tag.select class: "mt-1 block w-full rounded-lg border border-gray-300 bg-white px-3 py-2 text-sm text-gray-900 shadow-sm focus:border-gray-900 focus:ring-2 focus:ring-gray-900/20",
              data: { order_items_target: "ratePlan" } do %>
              <option value="">Select rate plan</option>
            <% end %>
          </div>
        </div>

        <p class="mt-2 text-sm text-red-600 hidden" data-order-items-target="error"></p>

        <div class="mt-4 flex justify-end gap-3">
          <button
            type="button"
            class="inline-flex items-center rounded-lg bg-white px-4 py-2 text-sm font-semibold text-gray-700 ring-1 ring-inset ring-gray-300 hover:bg-gray-50"
            data-action="order-items#cancelForm">
            Cancel
          </button>
          <button
            type="button"
            class="inline-flex items-center rounded-lg bg-gray-900 px-4 py-2 text-sm font-semibold text-white hover:bg-gray-800"
            data-action="order-items#addItem">
            Add item
          </button>
        </div>
      </div>

        <template data-order-items-target="rowTemplate">
        <div class="flex items-center justify-between rounded-2xl border border-gray-200 bg-white px-4 py-3 shadow-sm" data-role="row">
          <div>
            <p class="text-sm font-semibold text-gray-900" data-role="summary"></p>
            <p class="text-xs text-gray-500" data-role="details"></p>
          </div>
          <div class="flex items-center gap-4">
            <span class="text-sm font-medium text-gray-900" data-role="quantity"></span>
            <button type="button" class="text-sm font-medium text-rose-600 hover:text-rose-500" data-action="order-items#removeRow">
              Remove
            </button>
          </div>
          <div data-role="hiddenContainer" class="hidden"></div>
        </div>
        </template>
        <% end %>
      </div>

      <div>
        <%= f.label :notes, class: "text-sm font-medium text-gray-700" %>
        <%= f.text_area :notes,
          rows: 4,
          class: "mt-1 block w-full rounded-lg border border-gray-300 bg-white px-3 py-2 text-sm text-gray-900 shadow-sm focus:border-gray-900 focus:ring-2 focus:ring-gray-900/20" %>
      </div>
    </div>

    <aside class="mt-8 space-y-2 rounded-2xl border border-gray-100 bg-gray-50 p-5 lg:mt-0">
      <div>
        <p class="text-xs font-semibold uppercase tracking-wide text-gray-500">Unit availability</p>
        <p class="mt-1 text-sm text-gray-600">Weâ€™ll show how many units are free for the selected window.</p>
      </div>
      <div data-order-form-target="availability" class="mt-4 text-sm text-gray-600">
        Select start and end dates to see availability.
      </div>
    </aside>
  </div>

  <div class="flex justify-end">
    <%= f.submit "Save order",
      class: "inline-flex items-center rounded-lg bg-gray-900 px-4 py-2 text-sm font-semibold text-white hover:bg-gray-800" %>
  </div>
<% end %>

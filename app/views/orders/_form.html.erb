<%= form_with(model: order, html: { class: "space-y-8" }) do |f| %>
  <% if order.errors.any? %>
    <div class="rounded-lg border border-red-200 bg-red-50 p-4 text-sm text-red-800">
      <h2 class="font-semibold"><%= pluralize(order.errors.count, "error") %> prevented this order from saving:</h2>
      <ul class="mt-2 list-disc pl-5">
        <% order.errors.full_messages.each do |msg| %>
          <li><%= msg %></li>
        <% end %>
      </ul>
    </div>
  <% end %>

  <div class="grid grid-cols-1 gap-6 md:grid-cols-2">
    <div>
      <%= f.label :customer_id, "Customer", class: "text-sm font-medium text-gray-700" %>
      <%= f.collection_select :customer_id, Customer.order(:company_name), :id, :company_name,
        { include_blank: "Select customer" },
        class: "mt-1 w-full rounded-lg border-gray-300 text-sm shadow-sm focus:border-gray-900 focus:ring-gray-900" %>
    </div>

    <div>
      <%= f.label :location_id, "Location", class: "text-sm font-medium text-gray-700" %>
      <%= f.collection_select :location_id, Location.order(:label), :id, :label,
        { include_blank: "Select location" },
        class: "mt-1 w-full rounded-lg border-gray-300 text-sm shadow-sm focus:border-gray-900 focus:ring-gray-900" %>
    </div>

    <div>
      <%= f.label :external_reference, "Internal ref / PO #", class: "text-sm font-medium text-gray-700" %>
      <%= f.text_field :external_reference,
        class: "mt-1 w-full rounded-lg border-gray-300 text-sm shadow-sm focus:border-gray-900 focus:ring-gray-900" %>
    </div>

    <div>
      <%= f.label :status, class: "text-sm font-medium text-gray-700" %>
      <%= f.select :status, Order::STATUSES,
        {},
        class: "mt-1 w-full rounded-lg border-gray-300 text-sm shadow-sm focus:border-gray-900 focus:ring-gray-900" %>
    </div>

    <div>
      <%= f.label :start_date, class: "text-sm font-medium text-gray-700" %>
      <%= f.date_field :start_date,
        class: "mt-1 w-full rounded-lg border-gray-300 text-sm shadow-sm focus:border-gray-900 focus:ring-gray-900" %>
    </div>

    <div>
      <%= f.label :end_date, class: "text-sm font-medium text-gray-700" %>
      <%= f.date_field :end_date,
        class: "mt-1 w-full rounded-lg border-gray-300 text-sm shadow-sm focus:border-gray-900 focus:ring-gray-900" %>
    </div>
  </div>

  <div class="space-y-4">
    <div>
      <h2 class="text-lg font-semibold text-gray-900">Units & service schedules</h2>
      <p class="text-sm text-gray-600">Set quantity and service cadence for each unit type.</p>
    </div>

    <% schedule_options = [
      ["Weekly service (monthly)",   RatePlan::SERVICE_SCHEDULES[:weekly]],
      ["Biweekly service (monthly)", RatePlan::SERVICE_SCHEDULES[:biweekly]],
      ["Event only (deliver/pickup)", RatePlan::SERVICE_SCHEDULES[:event]]
    ] %>

    <div class="grid gap-4 md:grid-cols-2">
      <% UnitType.order(:name).each do |unit_type| %>
        <% qty_name   = "order[unit_type_requests][#{unit_type.id}][quantity]" %>
        <% sched_name = "order[unit_type_requests][#{unit_type.id}][service_schedule]" %>

        <% qty_value =
             if params.dig(:order, :unit_type_requests, unit_type.id.to_s, :quantity)
               params.dig(:order, :unit_type_requests, unit_type.id.to_s, :quantity)
             elsif order.persisted?
               order.units.where(unit_type_id: unit_type.id).count
             else
               0
             end %>

        <% sched_value =
             if params.dig(:order, :unit_type_requests, unit_type.id.to_s, :service_schedule)
               params.dig(:order, :unit_type_requests, unit_type.id.to_s, :service_schedule)
             else
               RatePlan::SERVICE_SCHEDULES[:weekly]
             end %>

        <div class="rounded-2xl border border-gray-200 p-4 shadow-sm">
          <div class="flex items-center justify-between">
            <div>
              <p class="text-base font-semibold text-gray-900"><%= unit_type.name %></p>
              <p class="text-xs text-gray-500">Prefix <%= unit_type.prefix %></p>
            </div>
          </div>

          <div class="mt-4 grid grid-cols-1 gap-4 sm:grid-cols-2">
            <div>
              <%= label_tag qty_name, "Quantity", class: "text-xs font-medium text-gray-700" %>
              <%= number_field_tag qty_name, qty_value,
                min: 0,
                step: 1,
                class: "mt-1 w-full rounded-lg border-gray-300 text-sm shadow-sm focus:border-gray-900 focus:ring-gray-900" %>
            </div>

            <div>
              <%= label_tag sched_name, "Service schedule", class: "text-xs font-medium text-gray-700" %>
              <%= select_tag sched_name,
                options_for_select(schedule_options, sched_value),
                class: "mt-1 w-full rounded-lg border-gray-300 text-sm shadow-sm focus:border-gray-900 focus:ring-gray-900" %>
            </div>
          </div>
        </div>
      <% end %>
    </div>
  </div>

  <div>
    <%= f.label :notes, class: "text-sm font-medium text-gray-700" %>
    <%= f.text_area :notes,
      rows: 4,
      class: "mt-1 w-full rounded-lg border-gray-300 text-sm shadow-sm focus:border-gray-900 focus:ring-gray-900" %>
  </div>

  <div class="flex justify-end">
    <%= f.submit "Save order",
      class: "inline-flex items-center rounded-lg bg-gray-900 px-4 py-2 text-sm font-semibold text-white hover:bg-gray-800" %>
  </div>
<% end %>

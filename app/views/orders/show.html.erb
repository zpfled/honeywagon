<div class="mx-auto max-w-6xl px-4 py-8">
  <!-- Header -->
  <div class="flex flex-col gap-4 sm:flex-row sm:items-start sm:justify-between">
    <div class="min-w-0">
      <div class="flex items-center gap-3">
        <h1 class="truncate text-2xl font-semibold text-gray-900">
          <%= @order_presenter.customer_name %>
        </h1>
        <%= @order_presenter.status_badge %>
      </div>

      <div class="mt-2 space-y-1 text-sm text-gray-600">
        <div class="flex items-center gap-2 text-gray-800">
          <span><%= @order_presenter.location_name %></span>
          <% if @order_presenter.location_address_line.present? %>
            <span class="text-gray-400">•</span>
            <span class="text-gray-600"><%= @order_presenter.location_address_line %></span>
          <% end %>
        </div>
        <div class="font-medium text-gray-700">
          <%= @order_presenter.start_date %> – <%= @order_presenter.end_date %>
        </div>
        <% if @order_presenter.external_reference.present? %>
          <div class="text-xs text-gray-500">
            External Ref:
            <span class="font-medium text-gray-700"><%= @order_presenter.external_reference %></span>
          </div>
        <% end %>
        <% if @order.order_series.present? %>
          <div class="text-xs text-gray-500">
            Series:
            <span class="font-medium text-gray-700"><%= @order.order_series.name %></span>
            <span class="text-gray-400">•</span>
            <span class="text-gray-600"><%= pluralize(@order.order_series.orders.count, "order") %></span>
          </div>
        <% end %>
      </div>
    </div>

    <!-- Actions -->
    <div class="flex flex-wrap gap-2">
      <% if @order_presenter.order.status == "draft" %>
        <%= button_to "Schedule",
          schedule_order_path(@order_presenter.order),
          method: :post,
          data: { turbo_confirm: "Schedule this order and generate service events?" },
          class: "inline-flex items-center rounded-lg bg-green-600 px-3 py-2 text-sm font-semibold text-white hover:bg-green-500" %>
      <% end %>

      <%= link_to "Back", orders_path,
        class: "inline-flex items-center rounded-lg bg-white px-3 py-2 text-sm font-medium text-gray-900 ring-1 ring-inset ring-gray-300 hover:bg-gray-50" %>

      <%= link_to "Edit", edit_order_path(@order_presenter.order),
        class: "inline-flex items-center rounded-lg bg-white px-3 py-2 text-sm font-medium text-gray-900 ring-1 ring-inset ring-gray-300 hover:bg-gray-50" %>
    </div>
  </div>

  <div class="mt-8 grid grid-cols-1 gap-6 lg:grid-cols-3">
    <!-- Left: Details -->
    <div class="lg:col-span-2 space-y-6">
      <% if @order_presenter.notes.present? %>
        <div class="rounded-2xl bg-white p-6 shadow-sm ring-1 ring-gray-200">
          <h2 class="text-base font-semibold text-gray-900">Notes</h2>
          <div class="mt-3 rounded-xl bg-gray-50 p-4 text-sm text-gray-800 whitespace-pre-wrap">
            <%= @order_presenter.notes %>
          </div>
        </div>
      <% end %>

      <!-- Line items -->
      <div class="rounded-2xl bg-white p-6 shadow-sm ring-1 ring-gray-200">
        <div class="flex items-center justify-between">
          <h2 class="text-base font-semibold text-gray-900">Line items</h2>
          <span class="text-sm text-gray-500">
            <%= @order_presenter.line_items_count %> items
          </span>
        </div>

        <div class="mt-4 overflow-hidden rounded-xl ring-1 ring-gray-200">
          <table class="min-w-full divide-y divide-gray-200">
            <thead class="bg-gray-50">
              <tr>
                <th class="px-4 py-3 text-left text-xs font-semibold uppercase tracking-wide text-gray-600">Unit type</th>
                <th class="px-4 py-3 text-left text-xs font-semibold uppercase tracking-wide text-gray-600">Schedule</th>
                <th class="px-4 py-3 text-right text-xs font-semibold uppercase tracking-wide text-gray-600">Qty</th>
                <th class="px-4 py-3 text-right text-xs font-semibold uppercase tracking-wide text-gray-600">Unit price</th>
                <th class="px-4 py-3 text-right text-xs font-semibold uppercase tracking-wide text-gray-600">Subtotal</th>
              </tr>
            </thead>

            <% line_items = @order_presenter.display_line_items %>
            <tbody class="divide-y divide-gray-100 bg-white">
              <% if line_items.any? %>
                <% line_items.each do |li| %>
                  <tr class="hover:bg-gray-50">
                    <td class="px-4 py-3 text-sm font-medium text-gray-900">
                      <%= @order_presenter.line_item_label(li) %>
                    </td>
                    <td class="px-4 py-3 text-sm text-gray-700">
                      <%= @order_presenter.line_item_schedule(li) %>
                    </td>
                    <td class="px-4 py-3 text-right text-sm text-gray-700">
                      <%= @order_presenter.line_item_quantity_value(li) %>
                    </td>
                    <td class="px-4 py-3 text-right text-sm text-gray-700">
                      <%= @order_presenter.line_item_unit_price_display(li) %>
                    </td>
                    <td class="px-4 py-3 text-right text-sm font-semibold text-gray-900">
                      <%= @order_presenter.line_item_subtotal_display(li) %>
                    </td>
                  </tr>
                <% end %>
              <% else %>
                <tr>
                  <td colspan="5" class="px-4 py-8 text-center text-sm text-gray-500">
                    No line items yet.
                  </td>
                </tr>
              <% end %>
            </tbody>

            <%# Footer subtotal row (presentation only) %>
            <% if @order_presenter.rental_line_items.any? %>
              <tfoot class="bg-gray-50">
                <tr>
                  <td colspan="4" class="px-4 py-3 text-right text-sm font-medium text-gray-700">
                    Subtotal
                  </td>
                  <td class="px-4 py-3 text-right text-sm font-semibold text-gray-900">
                    <%= @order_presenter.line_items_subtotal_currency %>
                  </td>
                </tr>
              </tfoot>
            <% end %>
          </table>
        </div>
      </div>

      <!-- Service events -->
      <div class="rounded-2xl bg-white p-6 shadow-sm ring-1 ring-gray-200">
        <div class="flex flex-wrap items-center justify-between gap-3">
          <div>
            <h2 class="text-base font-semibold text-gray-900">Service events</h2>
            <span class="text-sm text-gray-500"><%= @order_presenter.service_events_count %> scheduled</span>
          </div>
          <%= button_to "Reschedule service events",
                reschedule_service_events_order_path(@order_presenter.order),
                method: :post,
                data: { turbo_confirm: "Reschedule all scheduled service events for this order?" },
                class: "inline-flex items-center rounded-lg bg-white px-3 py-2 text-xs font-semibold text-gray-900 ring-1 ring-inset ring-gray-300 hover:bg-gray-50" %>
        </div>

        <div class="mt-4 rounded-xl border border-gray-100 bg-gray-50 p-4">
          <h3 class="text-sm font-semibold text-gray-900">Add manual service event</h3>
          <p class="mt-1 text-xs text-gray-600">Schedule an additional delivery, service, or pickup for any date.</p>

          <%= form_with url: order_service_events_path(@order_presenter.order),
                        scope: :service_event,
                        method: :post,
                        class: "mt-3 grid gap-3 sm:flex sm:items-end" do |f| %>
            <div>
              <%= f.label :event_type, "Event type", class: "text-xs font-medium text-gray-700" %>
              <%= f.select :event_type,
                           options_for_select((@service_event_types || ServiceEvent.event_types.except('dump', 'refill').keys).map { |type| [type.humanize, type] }),
                           {},
                           class: "mt-1 block rounded-lg border border-gray-300 bg-white px-3 py-2 text-sm text-gray-900 shadow-sm focus:border-gray-900 focus:ring-2 focus:ring-gray-900/20" %>
            </div>
            <div>
              <%= f.label :scheduled_on, "Scheduled date", class: "text-xs font-medium text-gray-700" %>
              <%= f.date_field :scheduled_on,
                               value: Date.current,
                               class: "mt-1 block rounded-lg border border-gray-300 bg-white px-3 py-2 text-sm text-gray-900 shadow-sm focus:border-gray-900 focus:ring-2 focus:ring-gray-900/20" %>
            </div>
            <div class="sm:mt-5">
              <%= f.submit "Add event",
                           class: "inline-flex items-center rounded-lg bg-gray-900 px-4 py-2 text-sm font-semibold text-white hover:bg-gray-800" %>
            </div>
          <% end %>
        </div>

        <% if @order_presenter.service_events.any? %>
          <div class="mt-4 divide-y divide-gray-100">
            <% @order_presenter.service_events.each do |event| %>
              <div class="flex flex-col gap-2 py-4 md:flex-row md:items-center md:justify-between">
                <div>
                  <p class="text-sm font-semibold text-gray-900">
                    Scheduled <%= l(event.scheduled_on) %>
                  </p>
                  <p class="text-xs text-gray-600">
                    <%= event.batch_label || event.event_type.to_s.humanize %>
                    <% if event.auto_generated? %>
                      • Auto-generated
                    <% end %>
                    <% if event.route.present? %>
                      • <%= link_to "Route #{event.route.route_date}", route_path(event.route), class: "text-emerald-600 hover:text-emerald-500" %>
                      • Route date <%= l(event.route.route_date) %>
                    <% else %>
                      • Not on a route
                    <% end %>
                  </p>
                  <% unless event.route.present? %>
                    <% routes_for_event = (@assignable_routes || []).select do |route| %>
                      <% event.scheduled_on.present? && route.route_date.between?(event.scheduled_on - 14.days, event.scheduled_on + 14.days) %>
                    <% end %>
                    <% if routes_for_event.any? %>
                      <%= form_with url: assign_route_order_service_event_path(@order_presenter.order, event),
                                    method: :patch,
                                    local: true,
                                    class: "mt-2 flex flex-col gap-2 sm:flex-row sm:items-center" do |f| %>
                        <div class="w-full sm:w-80">
                          <%= f.label :route_id, "Assign to route", class: "text-xs font-medium text-gray-700" %>
                          <%= f.select :route_id,
                                       options_for_select(routes_for_event.map do |route|
                                         label_parts = [ l(route.route_date) ]
                                         label_parts << route.truck&.label if route.truck
                                         label_parts << "Trailer #{route.trailer&.label}" if route.trailer&.respond_to?(:label)
                                         [ label_parts.compact.join(' — '), route.id ]
                                       end),
                                       { include_blank: "Select a route" },
                                       class: "mt-1 block w-full rounded-lg border border-gray-300 bg-white px-3 py-2 text-sm text-gray-900 shadow-sm focus:border-gray-900 focus:ring-2 focus:ring-gray-900/20" %>
                        </div>
                        <div>
                          <%= f.submit "Assign",
                                       class: "inline-flex items-center rounded-lg bg-gray-900 px-3 py-2 text-sm font-semibold text-white hover:bg-gray-800" %>
                        </div>
                      <% end %>
                    <% else %>
                      <p class="mt-2 text-xs text-gray-600">No routes within 2 weeks of the service date.</p>
                    <% end %>
                  <% end %>
                </div>

                <div class="flex items-center gap-3">
                  <span class="inline-flex items-center rounded-full px-2.5 py-1 text-xs font-semibold ring-1 ring-inset <%= event.status_scheduled? ? 'bg-blue-50 text-blue-700 ring-blue-200' : 'bg-emerald-50 text-emerald-700 ring-emerald-200' %>">
                    <%= event.status.humanize %>
                  </span>
                  <%= button_to "Delete",
                        order_service_event_path(@order_presenter.order, event),
                        method: :delete,
                        data: { turbo_confirm: "Delete this service event? This cannot be undone." },
                        class: "inline-flex items-center rounded-lg bg-white px-3 py-1.5 text-xs font-semibold text-rose-600 ring-1 ring-inset ring-rose-200 hover:bg-rose-50" %>
                </div>
              </div>
            <% end %>
          </div>
        <% else %>
          <div class="mt-4 rounded-xl bg-gray-50 p-6 text-sm text-gray-600">
            No service events scheduled yet.
          </div>
        <% end %>
      </div>
    </div>

    <!-- Right: Totals / Meta -->
    <div class="space-y-6">
      <div class="rounded-2xl bg-white p-6 shadow-sm ring-1 ring-gray-200">
        <h2 class="text-base font-semibold text-gray-900">Totals</h2>

        <dl class="mt-4 space-y-3">
          <div class="flex items-center justify-between">
            <dt class="text-sm text-gray-600">Line items subtotal</dt>
            <dd class="text-sm font-semibold text-gray-900">
              <%= @order_presenter.line_items_subtotal_currency %>
            </dd>
          </div>
        </dl>
      </div>

      <div class="rounded-2xl bg-white p-6 shadow-sm ring-1 ring-gray-200">
        <div class="flex items-center justify-between">
          <h2 class="text-base font-semibold text-gray-900">Assigned units</h2>
          <span class="text-sm text-gray-500"><%= @order_presenter.units_count %> units</span>
        </div>

        <% if @order_presenter.units.any? %>
          <ul class="mt-4 space-y-3">
            <% @order_presenter.units.each do |unit| %>
              <li class="rounded-xl border border-gray-200 bg-white p-4 hover:bg-gray-50">
                <div class="min-w-0">
                  <div class="truncate text-sm font-semibold text-gray-900">
                    <%= @order_presenter.unit_title(unit) %>
                  </div>
                  <div class="mt-1 text-sm text-gray-600">
                    <%= @order_presenter.unit_secondary_line(unit) %>
                  </div>
                </div>
              </li>
            <% end %>
          </ul>
        <% else %>
          <div class="mt-4 rounded-xl bg-gray-50 p-6 text-sm text-gray-600">
            No units assigned yet.
          </div>
        <% end %>
      </div>
    </div>
  </div>
</div>

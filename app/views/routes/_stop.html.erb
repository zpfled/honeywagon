<% stop = local_assigns.fetch(:stop) %>
<% event = stop.event %>
<tr class="<%= stop.row_classes %>"
    data-route-ordering-target="row"
    data-event-id="<%= stop.id %>">
  <td class="<%= table_cell_class %>">
    <div class="flex items-start gap-2">
      <div class="flex flex-col leading-tight">
        <span class="text-xs font-semibold text-gray-500" data-route-ordering-target="number">
          <%= stop.stop_number %>
        </span>
        <span class="text-[11px] text-gray-400">
          <%= stop.leg_distance || '—' %>
          <% if stop.fuel_cost %>
            • <%= stop.fuel_cost %>
          <% end %>
        </span>
      </div>
      <div class="flex flex-col">
        <button type="button"
                class="inline-flex h-6 w-6 items-center justify-center rounded-full text-gray-400 hover:text-gray-700 hover:bg-gray-100"
                title="Move up"
                data-action="route-ordering#moveUp">
          ↑
        </button>
        <button type="button"
                class="mt-1 inline-flex h-6 w-6 items-center justify-center rounded-full text-gray-400 hover:text-gray-700 hover:bg-gray-100"
                title="Move down"
                data-action="route-ordering#moveDown">
          ↓
        </button>
      </div>
    </div>
  </td>
  <td class="px-4 py-3">
    <div class="text-sm font-semibold <%= stop.overdue? ? 'text-rose-600' : 'text-gray-900' %>">
      <%= l(stop.scheduled_on_long, format: :long) %>
    </div>
    <div class="mt-1">
      <%= badge(stop.event_type_label, tone: :info) %>
    </div>
    <% if stop.overdue? %>
      <div class="mt-1 inline-flex items-center rounded-full bg-rose-50 px-2 py-0.5 text-xs font-semibold text-rose-700">
        Overdue • <%= pluralize(stop.days_overdue, 'day') %>
      </div>
    <% end %>
  </td>
  <td class="<%= table_cell_class %>">
    <%= stop.units_impacted %>
  </td>
  <td class="<%= table_cell_class %>">
    <% if stop.capacity_usage_rows.any? %>
      <div class="flex flex-col gap-0.5 text-[11px] leading-tight">
        <% stop.capacity_usage_rows.each do |usage| %>
          <span class="<%= usage[:css_class] %>"><%= usage[:label] %></span>
        <% end %>
        <% stop.capacity_violations.each do |violation| %>
          <span class="text-rose-700 font-semibold"><%= violation %></span>
        <% end %>
      </div>
    <% else %>
      <span class="text-xs text-gray-400">—</span>
    <% end %>
  </td>
  <td class="px-4 py-3">
    <% if stop.dump? %>
      <div class="text-sm font-semibold text-gray-900">
        <%= stop.dump_site_name %>
      </div>
      <div class="mt-1 text-xs text-gray-600">
        <%= stop.dump_site_location_label %>
      </div>
      <% if stop.dump_site_address %>
        <div class="mt-1 text-xs text-gray-600">
          <%= stop.dump_site_address %>
        </div>
      <% end %>
    <% elsif stop.refill? %>
      <div class="text-sm font-semibold text-gray-900">
        Home refill
      </div>
      <div class="mt-1 text-xs text-gray-600">
        <%= stop.refill_location_label %>
      </div>
      <% if stop.refill_address %>
        <div class="mt-1 text-xs text-gray-600">
          <%= stop.refill_address %>
        </div>
      <% end %>
    <% elsif stop.order.present? %>
      <div class="text-sm font-semibold text-gray-900">
        <%= link_to(stop.order_customer_name, order_path(stop.order), class: "hover:underline") %>
      </div>
      <div class="mt-1 text-xs text-gray-600">
        <%= stop.order_customer_email %>
      </div>
      <div class="mt-1 text-xs text-gray-600">
        <%= stop.order_location_label %> — <%= stop.order_city_state %>
      </div>
      <div class="mt-1 text-xs text-gray-600">
        <%= stop.order_date_range %>
      </div>
    <% else %>
      <div class="text-sm font-semibold text-gray-900">Unassigned</div>
    <% end %>
  </td>
  <td class="px-4 py-3">
    <div class="inline-flex items-center gap-3">
      <div class="inline-flex overflow-hidden rounded-full border border-gray-300 shadow-sm divide-x divide-gray-300 bg-white">
        <% if stop.disable_move_earlier? %>
          <span class="inline-flex items-center px-3 py-1.5 text-xs font-semibold text-gray-400 opacity-50 cursor-not-allowed" title="<%= stop.earlier_hint %>" aria-disabled="true">← Earlier</span>
        <% else %>
          <%= link_to "← Earlier",
                      advance_route_service_event_path(@route, event),
                      data: { turbo_method: :post, turbo_confirm: "Move this service event to the previous eligible route?" },
                      class: "inline-flex items-center px-3 py-1.5 text-xs font-semibold text-gray-700 hover:bg-gray-50 focus:z-10" %>
        <% end %>

        <% if stop.disable_move_later? %>
          <span class="inline-flex items-center px-3 py-1.5 text-xs font-semibold text-gray-400 opacity-50 cursor-not-allowed" title="<%= stop.later_hint %>" aria-disabled="true">Later →</span>
        <% else %>
          <%= link_to "Later →",
                      postpone_route_service_event_path(@route, event),
                      data: { turbo_method: :post, turbo_confirm: "Move this service event to the next route?" },
                      class: "inline-flex items-center px-3 py-1.5 text-xs font-semibold text-gray-700 hover:bg-gray-50 focus:z-10" %>
        <% end %>

        <% if stop.delivery? || stop.refill? %>
          <% if stop.completed? %>
            <span class="inline-flex items-center px-3 py-1.5 text-xs font-semibold text-emerald-600 opacity-50 cursor-not-allowed">Completed</span>
          <% else %>
            <%= link_to "Complete ✓",
                        complete_route_service_event_path(@route, event),
                        data: { turbo_method: :post, turbo_confirm: "Mark this service event complete?" },
                        class: "inline-flex items-center px-3 py-1.5 text-xs font-semibold text-emerald-600 hover:bg-emerald-50 focus:z-10" %>
          <% end %>
        <% else %>
          <% if stop.completed? %>
            <span class="inline-flex items-center px-3 py-1.5 text-xs font-semibold text-emerald-600 opacity-50">Completed</span>
          <% else %>
            <%= link_to "Complete ✓",
                        complete_route_service_event_path(@route, event),
                        class: "inline-flex items-center px-3 py-1.5 text-xs font-semibold text-emerald-600 hover:bg-emerald-50 focus:z-10",
                        data: { turbo_method: :post } %>
          <% end %>
        <% end %>
      </div>
      <span class="h-4 w-px bg-gray-200" aria-hidden="true"></span>
      <% if stop.completed? %>
        <span class="inline-flex items-center rounded-full bg-transparent px-2 py-1 text-gray-400 opacity-50 cursor-not-allowed" aria-disabled="true">
          <span class="sr-only">Delete</span>
          <svg class="h-4 w-4" viewBox="0 0 24 24" fill="currentColor" aria-hidden="true">
            <path d="M9 3h6a1 1 0 0 1 1 1v1h4a1 1 0 1 1 0 2h-1.1l-1.1 13.1a2 2 0 0 1-2 1.9H7.2a2 2 0 0 1-2-1.9L4.1 7H3a1 1 0 1 1 0-2h4V4a1 1 0 0 1 1-1Zm1 2v1h4V5Zm-2.9 2 1 12h8l1-12Z"/>
          </svg>
        </span>
      <% else %>
        <%= link_to route_service_event_path(@route, event),
                    data: { turbo_method: :delete, turbo_confirm: "Delete this service event? This cannot be undone." },
                    class: "inline-flex items-center rounded-full bg-transparent px-2 py-1 text-gray-400 hover:text-rose-600" do %>
          <span class="sr-only">Delete</span>
          <svg class="h-4 w-4" viewBox="0 0 24 24" fill="currentColor" aria-hidden="true">
            <path d="M9 3h6a1 1 0 0 1 1 1v1h4a1 1 0 1 1 0 2h-1.1l-1.1 13.1a2 2 0 0 1-2 1.9H7.2a2 2 0 0 1-2-1.9L4.1 7H3a1 1 0 1 1 0-2h4V4a1 1 0 0 1 1-1Zm1 2v1h4V5Zm-2.9 2 1 12h8l1-12Z"/>
          </svg>
        <% end %>
      <% end %>
    </div>
  </td>
</tr>

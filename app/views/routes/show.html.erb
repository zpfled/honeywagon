<%= page_shell do %>
  <div class="flex flex-col gap-2 sm:flex-row sm:items-center sm:justify-between">
    <div>
      <h1 class="text-2xl font-semibold text-gray-900">Route for <%= l(@route.route_date, format: "%A, %B %-d") %></h1>
      <p class="text-sm text-gray-600"><%= pluralize(@route.service_event_count, "service event") %> scheduled</p>
    </div>
    <div>
      <%= form_with model: @route, local: true do |f| %>
        <div class="grid gap-3 sm:flex sm:items-end">
          <div>
            <%= f.label :route_date, "Route date", class: "text-xs font-medium text-gray-700" %>
            <%= f.date_field :route_date, class: "mt-1 block rounded-lg border border-gray-300 px-3 py-2 text-sm text-gray-900 shadow-sm focus:border-gray-900 focus:ring-2 focus:ring-gray-900/20" %>
          </div>
          <div>
            <%= f.label :truck_id, "Truck", class: "text-xs font-medium text-gray-700" %>
            <% if @trucks.any? %>
              <%= f.collection_select :truck_id, @trucks, :id, :label, {},
                    class: "mt-1 block w-48 rounded-lg border border-gray-300 px-3 py-2 text-sm text-gray-900 shadow-sm focus:border-gray-900 focus:ring-2 focus:ring-gray-900/20" %>
            <% else %>
              <p class="mt-1 text-xs text-rose-600">Add a truck to assign this route.</p>
            <% end %>
          </div>
          <div>
            <%= f.label :trailer_id, "Trailer", class: "text-xs font-medium text-gray-700" %>
            <%= f.collection_select :trailer_id, @trailers, :id, :label,
                  { include_blank: "No trailer" },
                  class: "mt-1 block w-48 rounded-lg border border-gray-300 px-3 py-2 text-sm text-gray-900 shadow-sm focus:border-gray-900 focus:ring-2 focus:ring-gray-900/20" %>
          </div>
          <div>
            <%= f.submit "Update", class: button_classes(variant: :secondary), disabled: @trucks.empty? %>
          </div>
        </div>
      <% end %>
    </div>
  </div>

  <% capacity = @route.capacity_summary %>
  <% trailer_usage = capacity.trailer_usage %>
  <% clean_usage = capacity.clean_water_usage %>
  <% septage_usage = capacity.septage_usage %>

  <%= card classes: "mt-4 space-y-2" do %>
    <% if @route.over_capacity? %>
      <div class="rounded-lg border border-rose-200 bg-rose-50 p-3 text-sm text-rose-800">
        <p class="font-semibold">Over capacity</p>
        <p class="mt-1">
          <%= @route.over_capacity_dimensions.map { |dim| dim.to_s.humanize }.to_sentence %>.
          Consider postponing or reassigning events.
        </p>
      </div>
    <% end %>
    <div class="flex flex-wrap gap-4 text-sm text-gray-700">
      <span><span class="font-semibold text-gray-900">Truck:</span> <%= @route.truck&.label || "Unassigned" %></span>
      <span><span class="font-semibold text-gray-900">Trailer:</span> <%= @route.trailer&.label || "None" %></span>
      <span>
        <span class="font-semibold text-gray-900">Trailer spots:</span>
        <span class="<%= trailer_usage[:capacity] && trailer_usage[:used] > trailer_usage[:capacity] ? 'text-rose-700' : '' %>">
          <%= trailer_usage[:used] %> / <%= trailer_usage[:capacity] || '—' %>
        </span>
      </span>
      <span>
        <span class="font-semibold text-gray-900">Clean water:</span>
        <span class="<%= clean_usage[:capacity] && clean_usage[:used] > clean_usage[:capacity] ? 'text-rose-700' : '' %>">
          <%= clean_usage[:used] %> / <%= clean_usage[:capacity] || '—' %> gal
        </span>
      </span>
      <span>
        <span class="font-semibold text-gray-900">Septage:</span>
        <span class="<%= septage_usage[:capacity] && septage_usage[:used] > septage_usage[:capacity] ? 'text-rose-700' : '' %>">
          <%= septage_usage[:used] %> / <%= septage_usage[:capacity] || '—' %> gal
        </span>
      </span>
    </div>
  <% end %>

  <div class="mt-6 grid gap-4 md:grid-cols-4">
    <%= card do %>
      <p class="text-sm font-medium text-gray-600">Deliveries</p>
      <p class="mt-2 text-2xl font-semibold text-gray-900"><%= @route.deliveries_count %></p>
      <% if @route.delivery_unit_breakdown.any? %>
        <p class="mt-1 text-xs text-gray-600"><%= @route.delivery_unit_breakdown.join(', ') %></p>
      <% end %>
    <% end %>
    <%= card do %>
      <p class="text-sm font-medium text-gray-600">Services</p>
      <p class="mt-2 text-2xl font-semibold text-gray-900"><%= @route.services_count %></p>
      <% if @route.serviced_units_count.positive? %>
        <p class="mt-1 text-xs text-gray-600"><%= pluralize(@route.serviced_units_count, "unit") %> serviced</p>
      <% end %>
    <% end %>
    <%= card do %>
      <p class="text-sm font-medium text-gray-600">Pickups</p>
      <p class="mt-2 text-2xl font-semibold text-gray-900"><%= @route.pickups_count %></p>
      <% if @route.pickup_unit_breakdown.any? %>
        <p class="mt-1 text-xs text-gray-600"><%= @route.pickup_unit_breakdown.join(', ') %></p>
      <% end %>
    <% end %>
    <%= card do %>
      <p class="text-sm font-medium text-gray-600">Estimated gallons</p>
      <p class="mt-2 text-2xl font-semibold text-gray-900"><%= @route.estimated_gallons %></p>
    <% end %>
  </div>

  <%= card classes: "mt-6 overflow-hidden" do %>
    <table class="min-w-full divide-y divide-gray-200">
      <thead class="bg-gray-50">
        <tr>
          <th class="<%= table_header_class %>">Date</th>
          <th class="<%= table_header_class %>">Event</th>
          <th class="<%= table_header_class %>">Units</th>
          <th class="<%= table_header_class %>">Order</th>
          <th class="<%= table_header_class('text-right') %>">Actions</th>
        </tr>
      </thead>
      <tbody class="divide-y divide-gray-100 bg-white">
        <% if @service_events.any? %>
          <% @service_events.each do |event| %>
            <% order = event.order %>
            <tr class="hover:bg-gray-50">
              <td class="px-4 py-3 whitespace-nowrap">
                <div class="text-sm font-semibold text-gray-900"><%= l(event.scheduled_on, format: :long) %></div>
              </td>
              <td class="px-4 py-3">
                <div class="flex flex-col gap-1">
                  <%= badge(event.event_type.humanize, tone: :info) %>
                  <% if (status_badge = service_event_status_badge(event)) %>
                    <%= status_badge %>
                  <% end %>
                </div>
              </td>
              <td class="<%= table_cell_class %>">
                <%= event.units_impacted_count %>
              </td>
              <td class="px-4 py-3">
                <div class="text-sm font-semibold text-gray-900">
                  <%= link_to(order.customer.display_name, order_path(order), class: "hover:underline") %>
                </div>
                <div class="mt-1 text-xs text-gray-600">
                  <%= order.customer.billing_email %>
                </div>
                <div class="mt-1 text-xs text-gray-600">
                  <%= order.location.label %> — <%= [ order.location.city, order.location.state ].compact.join(', ') %>
                </div>
                <div class="mt-1 text-xs text-gray-600">
                  <%= l(order.start_date) %> <span class="text-gray-400">→</span> <%= l(order.end_date) %>
                </div>
              </td>
              <td class="px-4 py-3">
                <div class="flex flex-col items-end gap-2">
                  <%= button_to "Postpone",
                                postpone_route_service_event_path(@route, event),
                                method: :post,
                                data: { turbo_confirm: "Move this service event to the next route?" },
                                class: button_classes(variant: :outline, size: :sm) %>
                  <%= button_to "Delete",
                                order_service_event_path(order, event),
                                method: :delete,
                                data: { turbo_confirm: "Delete this service event? This cannot be undone." },
                                class: button_classes(variant: :danger, size: :sm) %>
                </div>
              </td>
            </tr>
          <% end %>
        <% else %>
          <tr>
            <td colspan="5" class="<%= table_cell_class('text-center', tone: :muted) %>">No service events assigned to this route yet.</td>
          </tr>
        <% end %>
      </tbody>
    </table>
  <% end %>
<% end %>

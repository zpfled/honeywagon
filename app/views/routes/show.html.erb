<%= page_shell do %>
  <div class="flex flex-col gap-2 sm:flex-row sm:items-center sm:justify-between">
    <div>
      <h1 class="text-2xl font-semibold text-gray-900">Route for <%= l(@route.route_date, format: "%A, %B %-d") %></h1>
      <ul class="mt-1 flex flex-wrap gap-2 text-xs text-gray-600">
        <li><%= pluralize(@route.deliveries_count, 'delivery') %></li>
        <li><%= pluralize(@route.services_count, 'service') %> (<%= pluralize(@route.serviced_units_count, 'unit') %>)</li>
        <li><%= pluralize(@route.pickups_count, 'pickup') %></li>
        <li><%= number_to_human(@route.estimated_gallons, units: { unit: 'gal' }, format: '%n %u') %> pumped</li>
      </ul>
    </div>
    <div>
      <details class="rounded-xl border border-gray-200 bg-white shadow-sm">
        <summary class="cursor-pointer select-none rounded-xl px-4 py-2 text-sm font-medium text-gray-700 hover:bg-gray-50">
          Edit route details
        </summary>
        <div class="border-t border-gray-100 px-4 py-3">
          <%= form_with model: @route, local: true do |f| %>
            <div class="grid gap-3 sm:flex sm:flex-wrap sm:items-end">
              <div>
                <%= f.label :route_date, "Route date", class: "text-xs font-medium text-gray-700" %>
                <%= f.date_field :route_date, class: "mt-1 block rounded-lg border border-gray-300 px-3 py-2 text-sm text-gray-900 shadow-sm focus:border-gray-900 focus:ring-2 focus:ring-gray-900/20" %>
              </div>
              <div>
                <%= f.label :truck_id, "Truck", class: "text-xs font-medium text-gray-700" %>
                <% if @trucks.any? %>
                  <%= f.collection_select :truck_id, @trucks, :id, :label, {},
                        class: "mt-1 block w-48 rounded-lg border border-gray-300 px-3 py-2 text-sm text-gray-900 shadow-sm focus:border-gray-900 focus:ring-2 focus:ring-gray-900/20" %>
                <% else %>
                  <p class="mt-1 text-xs text-rose-600">Add a truck to assign this route.</p>
                <% end %>
              </div>
              <div>
                <%= f.label :trailer_id, "Trailer", class: "text-xs font-medium text-gray-700" %>
                <%= f.collection_select :trailer_id, @trailers, :id, :label,
                      { include_blank: "No trailer" },
                      class: "mt-1 block w-48 rounded-lg border border-gray-300 px-3 py-2 text-sm text-gray-900 shadow-sm focus:border-gray-900 focus:ring-2 focus:ring-gray-900/20" %>
              </div>
              <div>
                <%= f.submit "Update", class: button_classes(variant: :secondary), disabled: @trucks.empty? %>
              </div>
            </div>
          <% end %>
        </div>
      </details>
    </div>
  </div>

  <%# TODO: extract header/forecast into a partial backed by RoutePresenter %>
  <% if @previous_route || @next_route || @weather_forecast %>
    <div class="mt-4 flex flex-col gap-3 text-xs text-gray-600 sm:flex-row sm:items-center sm:justify-between">
      <div class="sm:w-1/3">
        <% if @previous_route %>
          <%= link_to route_path(@previous_route),
              class: "inline-flex items-center rounded-full border border-gray-200 bg-white px-3 py-1.5 font-semibold text-gray-700 shadow-sm hover:bg-gray-50" do %>
            ← <%= l(@previous_route.route_date, format: "%A, %B %-d") %>
          <% end %>
        <% end %>
      </div>
      <div class="text-center sm:w-1/3">
        <% if @weather_forecast %>
          <p class="text-xs font-semibold uppercase tracking-wide text-gray-500">Forecast</p>
          <div class="mt-1 flex flex-wrap items-center justify-center gap-3 text-sm">
            <% if @weather_forecast.high_temp.present? %>
              <span class="<%= freeze_risk_class(@weather_forecast.high_temp) %>">High <%= @weather_forecast.high_temp %>°F</span>
            <% end %>
            <% if @weather_forecast.low_temp.present? %>
              <span class="<%= freeze_risk_class(@weather_forecast.low_temp) %>">Low <%= @weather_forecast.low_temp %>°F</span>
            <% end %>
            <% if @weather_forecast.precip_percent.present? %>
              <span><%= @weather_forecast.precip_percent %>% precip</span>
            <% end %>
          </div>
          <% if @weather_forecast.summary.present? %>
            <p class="mt-1 text-xs text-gray-600"><%= @weather_forecast.summary %></p>
          <% end %>
        <% end %>
      </div>
      <div class="sm:w-1/3 sm:text-right">
        <% if @next_route %>
          <%= link_to route_path(@next_route),
              class: "inline-flex items-center rounded-full border border-gray-200 bg-white px-3 py-1.5 font-semibold text-gray-700 shadow-sm hover:bg-gray-50" do %>
            <%= l(@next_route.route_date, format: "%A, %B %-d") %> →
          <% end %>
        <% end %>
      </div>
    </div>
  <% end %>

  <%# TODO: move capacity/waste/drive summary into RoutePresenter/RouteSummaryPresenter %>
  <% trailer_usage = @route_summary.trailer_usage %>
  <% clean_usage = @route_summary.clean_usage %>
  <% waste_summary = @route_summary.waste_summary %>
  <% waste_used = waste_summary[:cumulative_used] %>
  <% waste_capacity = waste_summary[:capacity] %>
  <% drive_time = @route_summary.drive_time %>
  <% drive_distance = @route_summary.drive_distance %>

  <%= card classes: "mt-4" do %>
    <div class="flex flex-col gap-3 text-sm text-gray-700 sm:flex-row sm:flex-wrap sm:items-center">
      <span><span class="font-semibold text-gray-900">Truck:</span> <%= @route_summary.truck_label %></span>
      <span><span class="font-semibold text-gray-900">Trailer:</span> <%= @route_summary.trailer_label %></span>
      <span>
        <span class="font-semibold text-gray-900">Trailer spots:</span>
        <span class="<%= trailer_usage[:capacity] && trailer_usage[:used] > trailer_usage[:capacity] ? 'text-rose-700' : '' %>">
          <%= trailer_usage[:used] %> / <%= trailer_usage[:capacity] || '—' %>
        </span>
      </span>
      <span>
        <span class="font-semibold text-gray-900">Clean water:</span>
        <span class="<%= clean_usage[:capacity] && clean_usage[:used] > clean_usage[:capacity] ? 'text-rose-700' : '' %>">
          <%= clean_usage[:used] %> / <%= clean_usage[:capacity] || '—' %> gal
        </span>
      </span>
      <span>
        <span class="font-semibold text-gray-900">Waste:</span>
        <span class="<%= waste_summary[:over_capacity] ? 'text-rose-700' : '' %>">
          <%= waste_used %> / <%= waste_capacity || '—' %> gal
        </span>
      </span>
      <span>
        <span class="font-semibold text-gray-900">Est. drive:</span>
        <% if drive_time.present? || drive_distance.present? %>
          <span><%= [ drive_time, drive_distance ].compact.join(' • ') %></span>
        <% else %>
          <span class="text-gray-500">Run optimizer</span>
        <% end %>
      </span>
      <% if @route_summary.optimization_stale? %>
        <span class="inline-flex items-center rounded-full bg-amber-100 px-2 py-0.5 text-xs font-semibold text-amber-800">
          Needs re-optimization
        </span>
      <% end %>
    </div>
  <% end %>


  <%= card classes: "mt-4" do %>
    <div class="flex flex-col gap-3 sm:flex-row sm:items-center sm:justify-between">
      <% if @dump_sites.any? %>
        <%= form_with url: route_dump_events_path(@route), scope: :dump_event, local: true, class: "flex flex-col gap-2 sm:flex-row sm:items-center" do |f| %>
          <%= f.label :dump_site_id, "Dump site", class: "text-xs font-medium text-gray-700" %>
          <%= f.select :dump_site_id,
                       options_for_select(@dump_sites.map { |site| ["#{site.name} — #{site.location.display_label}", site.id] }),
                       { include_blank: "Pick a site" },
                       class: "rounded-lg border border-gray-300 px-3 py-2 text-sm text-gray-900 shadow-sm focus:border-gray-900 focus:ring-2 focus:ring-gray-900/20" %>
          <%= f.submit "Add dump event", class: button_classes %>
        <% end %>
      <% else %>
        <div class="text-sm text-gray-600">
          No dump sites yet.
          <%= link_to "Add one in settings.", edit_company_path(anchor: "dump-sites"), class: "font-medium text-gray-900 hover:underline" %>
        </div>
      <% end %>

      <%= button_to "Optimize route",
                    route_optimization_path(@route),
                    method: :post,
                    class: button_classes(variant: :secondary) %>
    </div>
  <% end %>

  <%# TODO: Replace inline stop rendering with StopPresenter + partial for readability and testability %>
  <%= card classes: "mt-6 overflow-hidden" do %>
    <%= form_with url: route_ordering_path(@route),
                  method: :patch,
                  local: true,
                  data: { controller: "route-ordering", action: "submit->route-ordering#submit" } do %>
      <div class="flex items-center justify-between px-4 py-3 bg-gray-50 border-b border-gray-200">
        <p class="text-sm font-semibold text-gray-900">Route stops</p>
        <div class="flex items-center gap-2">
          <button type="submit" class="<%= button_classes(variant: :outline, size: :sm) %>">Save order</button>
        </div>
      </div>
      <div class="hidden" data-route-ordering-target="inputContainer">
        <% @stop_presenters.each do |stop| %>
          <%= hidden_field_tag "event_ids[]", stop.id %>
        <% end %>
      </div>
      <table class="min-w-full divide-y divide-gray-200">
        <thead class="bg-gray-50">
          <tr>
            <th class="<%= table_header_class %>">Stop</th>
            <th class="<%= table_header_class %>">Scheduled event</th>
            <th class="<%= table_header_class %>">Units</th>
            <th class="<%= table_header_class %>">Usage</th>
            <th class="<%= table_header_class %>">Order</th>
            <th class="<%= table_header_class('text-right') %>">Actions</th>
          </tr>
        </thead>
        <tbody class="divide-y divide-gray-100 bg-white">
          <% if @stop_presenters.any? %>
            <% @stop_presenters.each do |stop| %>
              <%= render partial: "routes/stop", locals: { stop: stop } %>
            <% end %>
          <% else %>
            <tr>
              <td colspan="5" class="<%= table_cell_class('text-center', tone: :muted) %>">No service events assigned to this route yet.</td>
            </tr>
          <% end %>
        </tbody>
      </table>
    <% end %>
  <% end %>
<% end %>

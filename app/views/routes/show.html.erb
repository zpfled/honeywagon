<%= page_shell do %>
  <div class="flex flex-col gap-2 sm:flex-row sm:items-center sm:justify-between">
    <div>
      <h1 class="text-2xl font-semibold text-gray-900">Route for <%= l(@route.route_date, format: "%A, %B %-d") %></h1>
      <p class="text-sm text-gray-600"><%= pluralize(@route.service_event_count, "service event") %> scheduled</p>
    </div>
    <div>
      <%= form_with model: @route, local: true do |f| %>
        <div class="grid gap-3 sm:flex sm:items-end">
          <div>
            <%= f.label :route_date, "Route date", class: "text-xs font-medium text-gray-700" %>
            <%= f.date_field :route_date, class: "mt-1 block rounded-lg border border-gray-300 px-3 py-2 text-sm text-gray-900 shadow-sm focus:border-gray-900 focus:ring-2 focus:ring-gray-900/20" %>
          </div>
          <div>
            <%= f.label :truck_id, "Truck", class: "text-xs font-medium text-gray-700" %>
            <% if @trucks.any? %>
              <%= f.collection_select :truck_id, @trucks, :id, :label, {},
                    class: "mt-1 block w-48 rounded-lg border border-gray-300 px-3 py-2 text-sm text-gray-900 shadow-sm focus:border-gray-900 focus:ring-2 focus:ring-gray-900/20" %>
            <% else %>
              <p class="mt-1 text-xs text-rose-600">Add a truck to assign this route.</p>
            <% end %>
          </div>
          <div>
            <%= f.label :trailer_id, "Trailer", class: "text-xs font-medium text-gray-700" %>
            <%= f.collection_select :trailer_id, @trailers, :id, :label,
                  { include_blank: "No trailer" },
                  class: "mt-1 block w-48 rounded-lg border border-gray-300 px-3 py-2 text-sm text-gray-900 shadow-sm focus:border-gray-900 focus:ring-2 focus:ring-gray-900/20" %>
          </div>
          <div>
            <%= f.submit "Update", class: button_classes(variant: :secondary), disabled: @trucks.empty? %>
          </div>
        </div>
      <% end %>
    </div>
  </div>

  <% if @previous_route || @next_route %>
    <div class="mt-4 flex items-center justify-between text-xs text-gray-600">
      <div>
        <% if @previous_route %>
          <%= link_to route_path(@previous_route),
              class: "inline-flex items-center rounded-full border border-gray-200 bg-white px-3 py-1.5 font-semibold text-gray-700 shadow-sm hover:bg-gray-50" do %>
            ← <%= l(@previous_route.route_date, format: "%A, %B %-d") %>
          <% end %>
        <% end %>
      </div>
      <div>
        <% if @next_route %>
          <%= link_to route_path(@next_route),
              class: "inline-flex items-center rounded-full border border-gray-200 bg-white px-3 py-1.5 font-semibold text-gray-700 shadow-sm hover:bg-gray-50" do %>
            <%= l(@next_route.route_date, format: "%A, %B %-d") %> →
          <% end %>
        <% end %>
      </div>
    </div>
  <% end %>

  <% capacity = @route.capacity_summary %>
  <% trailer_usage = capacity.trailer_usage %>
  <% clean_usage = capacity.clean_water_usage %>
  <% septage_usage = capacity.septage_usage %>

  <%= card classes: "mt-4 space-y-2" do %>
    <% if @route.over_capacity? %>
      <div class="rounded-lg border border-rose-200 bg-rose-50 p-3 text-sm text-rose-800">
        <p class="font-semibold">Over capacity</p>
        <p class="mt-1">
          <%= @route.over_capacity_dimensions.map { |dim| dim.to_s.humanize }.to_sentence %>.
          Consider postponing or reassigning events.
        </p>
      </div>
    <% end %>
    <div class="flex flex-wrap gap-4 text-sm text-gray-700">
      <span><span class="font-semibold text-gray-900">Truck:</span> <%= @route.truck&.label || "Unassigned" %></span>
      <span><span class="font-semibold text-gray-900">Trailer:</span> <%= @route.trailer&.label || "None" %></span>
      <span>
        <span class="font-semibold text-gray-900">Trailer spots:</span>
        <span class="<%= trailer_usage[:capacity] && trailer_usage[:used] > trailer_usage[:capacity] ? 'text-rose-700' : '' %>">
          <%= trailer_usage[:used] %> / <%= trailer_usage[:capacity] || '—' %>
        </span>
      </span>
      <span>
        <span class="font-semibold text-gray-900">Clean water:</span>
        <span class="<%= clean_usage[:capacity] && clean_usage[:used] > clean_usage[:capacity] ? 'text-rose-700' : '' %>">
          <%= clean_usage[:used] %> / <%= clean_usage[:capacity] || '—' %> gal
        </span>
      </span>
      <% default_summary = {
           cumulative_used: septage_usage[:used],
           capacity: septage_usage[:capacity],
           remaining: septage_usage[:capacity] ? septage_usage[:capacity] - septage_usage[:used] : nil,
           over_capacity: septage_usage[:capacity] && septage_usage[:used] > septage_usage[:capacity]
         } %>
      <% septage_summary = @septage_load || default_summary %>
      <% septage_used = septage_summary[:cumulative_used] || septage_usage[:used] %>
      <% septage_capacity = septage_summary[:capacity] %>
      <span>
        <span class="font-semibold text-gray-900">Septage:</span>
        <span class="<%= septage_summary[:over_capacity] ? 'text-rose-700' : '' %>">
          <%= septage_used %> / <%= septage_capacity || '—' %> gal
        </span>
        <% if septage_summary[:remaining] %>
          <span class="text-xs text-gray-500">(Remaining: <%= septage_summary[:remaining] %> gal)</span>
        <% end %>
      </span>
    </div>
  <% end %>

  <div class="mt-6 grid gap-4 md:grid-cols-4">
    <%= card do %>
      <p class="text-sm font-medium text-gray-600">Deliveries</p>
      <p class="mt-2 text-2xl font-semibold text-gray-900"><%= @route.deliveries_count %></p>
      <% if @route.delivery_unit_breakdown.any? %>
        <p class="mt-1 text-xs text-gray-600"><%= @route.delivery_unit_breakdown.join(', ') %></p>
      <% end %>
    <% end %>
    <%= card do %>
      <p class="text-sm font-medium text-gray-600">Services</p>
      <p class="mt-2 text-2xl font-semibold text-gray-900"><%= @route.services_count %></p>
      <% if @route.serviced_units_count.positive? %>
        <p class="mt-1 text-xs text-gray-600"><%= pluralize(@route.serviced_units_count, "unit") %> serviced</p>
      <% end %>
    <% end %>
    <%= card do %>
      <p class="text-sm font-medium text-gray-600">Pickups</p>
      <p class="mt-2 text-2xl font-semibold text-gray-900"><%= @route.pickups_count %></p>
      <% if @route.pickup_unit_breakdown.any? %>
        <p class="mt-1 text-xs text-gray-600"><%= @route.pickup_unit_breakdown.join(', ') %></p>
      <% end %>
    <% end %>
    <%= card do %>
      <p class="text-sm font-medium text-gray-600">Estimated gallons pumped</p>
      <p class="mt-2 text-2xl font-semibold text-gray-900"><%= @route.estimated_gallons %></p>
    <% end %>
  </div>

  <%= card classes: "mt-6 overflow-hidden" do %>
    <table class="min-w-full divide-y divide-gray-200">
      <thead class="bg-gray-50">
        <tr>
          <th class="<%= table_header_class %>">Date</th>
          <th class="<%= table_header_class %>">Event</th>
          <th class="<%= table_header_class %>">Units</th>
          <th class="<%= table_header_class %>">Order</th>
          <th class="<%= table_header_class('text-right') %>">Actions</th>
        </tr>
      </thead>
      <tbody class="divide-y divide-gray-100 bg-white">
        <% if @service_events.any? %>
          <% @service_events.each do |event| %>
            <% order = event.order %>
            <% completed = event.status_completed? %>
            <% disable_later = completed || event.prevent_move_later? %>
            <% disable_earlier = completed || event.prevent_move_earlier? %>
            <% later_hint = if event.prevent_move_later?
                              event.event_type_delivery? ? 'Deliveries must stay on or before their scheduled date.' : 'Pickups must stay on their scheduled date.'
                            end %>
            <% earlier_hint = if event.prevent_move_earlier?
                                'Pickups must stay on their scheduled date.'
                              end %>
            <tr class="hover:bg-gray-50 <%= completed ? 'opacity-60 bg-emerald-50' : '' %>">
              <td class="px-4 py-3 whitespace-nowrap">
                <div class="text-sm font-semibold <%= event.overdue? ? 'text-rose-600' : 'text-gray-900' %>">
                  <%= l(event.scheduled_on, format: :long) %>
                </div>
                <% if event.overdue? %>
                  <div class="mt-1 inline-flex items-center rounded-full bg-rose-50 px-2 py-0.5 text-xs font-semibold text-rose-700">
                    Overdue • <%= pluralize(event.days_overdue, 'day') %>
                  </div>
                <% end %>
              </td>
              <td class="px-4 py-3">
                <%= badge(event.event_type.humanize, tone: :info) %>
              </td>
              <td class="<%= table_cell_class %>">
                <%= event.units_impacted_count %>
              </td>
              <td class="px-4 py-3">
                <div class="text-sm font-semibold text-gray-900">
                  <%= link_to(order.customer.display_name, order_path(order), class: "hover:underline") %>
                </div>
                <div class="mt-1 text-xs text-gray-600">
                  <%= order.customer.billing_email %>
                </div>
                <div class="mt-1 text-xs text-gray-600">
                  <%= order.location.label %> — <%= [ order.location.city, order.location.state ].compact.join(', ') %>
                </div>
                <div class="mt-1 text-xs text-gray-600">
                  <%= l(order.start_date) %> <span class="text-gray-400">→</span> <%= l(order.end_date) %>
                </div>
              </td>
              <td class="px-4 py-3">
                <div class="inline-flex items-center gap-3">
                  <div class="inline-flex overflow-hidden rounded-full border border-gray-300 shadow-sm divide-x divide-gray-300 bg-white">
                    <%= button_to "← Earlier",
                                  advance_route_service_event_path(@route, event),
                                  method: :post,
                                  data: { turbo_confirm: "Move this service event to the previous eligible route?" },
                                  class: "inline-flex items-center px-3 py-1.5 text-xs font-semibold text-gray-700 hover:bg-gray-50 focus:z-10 #{'opacity-50 cursor-not-allowed' if disable_earlier}",
                                  disabled: disable_earlier,
                                  title: earlier_hint %>
                    <%= button_to "Later →",
                                  postpone_route_service_event_path(@route, event),
                                  method: :post,
                                  data: { turbo_confirm: "Move this service event to the next route?" },
                                  class: "inline-flex items-center px-3 py-1.5 text-xs font-semibold text-gray-700 hover:bg-gray-50 focus:z-10 #{'opacity-50 cursor-not-allowed' if disable_later}",
                                  disabled: disable_later,
                                  title: later_hint %>
                    <% if event.event_type_delivery? %>
                      <%= button_to "Complete ✓",
                                    complete_route_service_event_path(@route, event),
                                    method: :post,
                                    data: { turbo_confirm: "Mark this service event complete?" },
                                    class: "inline-flex items-center px-3 py-1.5 text-xs font-semibold text-emerald-600 hover:bg-emerald-50 focus:z-10 #{'opacity-50 cursor-not-allowed' if completed}",
                                    disabled: completed %>
                    <% else %>
                      <% if completed %>
                        <span class="inline-flex items-center px-3 py-1.5 text-xs font-semibold text-emerald-600 opacity-50">Completed</span>
                      <% else %>
                      <%= link_to "Complete ✓",
                                  new_service_event_report_path(service_event_id: event.id, redirect_path: route_path(@route)),
                                  class: "inline-flex items-center px-3 py-1.5 text-xs font-semibold text-emerald-600 hover:bg-emerald-50 focus:z-10",
                                  data: { turbo_frame: "service_event_modal" } %>
                      <% end %>
                    <% end %>
                  </div>
                  <span class="h-4 w-px bg-gray-200" aria-hidden="true"></span>
                  <%= button_to order_service_event_path(order, event),
                                method: :delete,
                                data: { turbo_confirm: "Delete this service event? This cannot be undone." },
                                class: "inline-flex items-center rounded-full bg-transparent px-2 py-1 text-gray-400 hover:text-rose-600 #{'opacity-50 cursor-not-allowed' if completed}",
                                disabled: completed do %>
                    <span class="sr-only">Delete</span>
                    <svg class="h-4 w-4" viewBox="0 0 24 24" fill="currentColor" aria-hidden="true">
                      <path d="M9 3h6a1 1 0 0 1 1 1v1h4a1 1 0 1 1 0 2h-1.1l-1.1 13.1a2 2 0 0 1-2 1.9H7.2a2 2 0 0 1-2-1.9L4.1 7H3a1 1 0 1 1 0-2h4V4a1 1 0 0 1 1-1Zm1 2v1h4V5Zm-2.9 2 1 12h8l1-12Z"/>
                    </svg>
                  <% end %>
                </div>
              </td>
            </tr>
          <% end %>
        <% else %>
          <tr>
            <td colspan="5" class="<%= table_cell_class('text-center', tone: :muted) %>">No service events assigned to this route yet.</td>
          </tr>
        <% end %>
      </tbody>
    </table>
  <% end %>
<% end %>

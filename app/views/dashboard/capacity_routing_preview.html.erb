<%= page_shell do %>
  <div class="mt-4 flex flex-wrap items-start gap-3">
    <div class="min-w-0">
      <h1 class="text-xl font-semibold text-gray-900">Capacity routing preview (Phase 3)</h1>
      <p class="text-sm text-gray-600">
        Read-only preview • <%= @preview.horizon_days %>-day horizon
      </p>
    </div>
    <div class="ml-auto flex gap-2">
      <%= link_to "Back to dashboard", authenticated_root_path, class: button_classes(variant: :secondary) %>
    </div>
  </div>

  <%= card classes: "mt-6" do %>
    <% if @preview.routes.any? %>
      <div class="space-y-4">
        <% @preview.routes.each do |route| %>
          <div class="rounded-2xl border border-gray-200 bg-white px-4 py-3 shadow-sm">
            <div class="flex flex-wrap items-center gap-2">
              <p class="text-sm font-semibold text-gray-900">
                Route <%= route.index %>
              </p>
              <% if route.date %>
                <span class="text-xs text-gray-500">• <%= l(route.date, format: :long) %></span>
              <% end %>
            </div>
            <div class="mt-2 flex flex-wrap gap-3 text-xs text-gray-600">
              <div>
                Trailer spots: <span class="text-gray-900 font-semibold"><%= route.usage[:trailer_spots] %></span>
                / <%= route.trailer_capacity || "—" %>
              </div>
              <div>
                Waste tank: <span class="text-gray-900 font-semibold"><%= route.usage[:waste_gallons] %></span>
                / <%= route.waste_capacity || "—" %> gal
              </div>
              <div>
                Clean tank: <span class="text-gray-900 font-semibold"><%= route.usage[:clean_water_gallons] %></span>
                / <%= route.clean_capacity || "—" %> gal
              </div>
            </div>
            <div class="mt-3 overflow-hidden rounded-xl border border-gray-100">
              <table class="min-w-full divide-y divide-gray-100 text-sm">
                <thead class="bg-gray-50 text-xs uppercase text-gray-500">
                  <tr>
                    <th class="px-3 py-2 text-left font-semibold">Stop</th>
                    <th class="px-3 py-2 text-left font-semibold">Location</th>
                    <th class="px-3 py-2 text-left font-semibold">Customer</th>
                    <th class="px-3 py-2 text-left font-semibold">Scheduled</th>
                    <th class="px-3 py-2 text-left font-semibold">Capacity</th>
                    <th class="px-3 py-2 text-left font-semibold">Notes</th>
                  </tr>
                </thead>
                <tbody class="divide-y divide-gray-100">
                  <% route.stops.each do |stop| %>
                    <tr>
                      <td class="px-3 py-2 font-medium text-gray-900">
                        <div class="flex flex-wrap items-center gap-2">
                          <%= badge(stop.kind_label, tone: stop.tone || :info) %>
                          <span><%= stop.label %></span>
                        </div>
                      </td>
                      <td class="px-3 py-2 text-gray-700"><%= stop.location_label || '—' %></td>
                      <td class="px-3 py-2 text-gray-700"><%= stop.customer_name || '—' %></td>
                      <td class="px-3 py-2 text-gray-700">
                        <%= stop.scheduled_on ? l(stop.scheduled_on, format: :long) : '—' %>
                      </td>
                      <td class="px-3 py-2 <%= stop.capacity_over ? 'text-rose-600 font-semibold' : 'text-gray-600' %>">
                        <%= stop.capacity_label || '—' %>
                      </td>
                      <td class="px-3 py-2 text-gray-500"><%= stop.notes || '—' %></td>
                    </tr>
                  <% end %>
                </tbody>
              </table>
            </div>
          </div>
        <% end %>
      </div>
    <% else %>
      <p class="text-sm text-gray-600">No scheduled service events found within the horizon.</p>
    <% end %>
  <% end %>
<% end %>

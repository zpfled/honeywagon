<%= page_shell do %>
  <div class="flex flex-wrap items-center justify-between gap-4">
    <div>
      <h1 class="text-2xl font-semibold text-gray-900">Tasks for <%= l(@date, format: :long) %></h1>
      <p class="mt-1 text-sm text-gray-600">Company-level operational checklist.</p>
    </div>
    <div class="flex items-center gap-2">
      <%= link_to "← Previous day", tasks_path(date: (@date - 1.day).to_s),
                  class: button_classes(variant: :outline, size: :sm) %>
      <%= link_to "Next day →", tasks_path(date: (@date + 1.day).to_s),
                  class: button_classes(variant: :outline, size: :sm) %>
      <%= link_to "Back to calendar", calendar_routes_path, class: button_classes(variant: :outline, size: :sm) %>
    </div>
  </div>

  <div class="mt-6 space-y-6">
    <%= card do %>
      <h2 class="text-lg font-semibold text-gray-900">Add task</h2>
      <%= form_with model: @task, url: tasks_path, class: "mt-4 grid gap-3" do |f| %>
        <% if @task.errors.any? %>
          <div class="rounded-lg border border-red-200 bg-red-50 p-4 text-sm text-red-800">
            <p class="font-semibold"><%= pluralize(@task.errors.count, "error") %> prevented this task from saving:</p>
            <ul class="mt-2 list-disc pl-4">
              <% @task.errors.full_messages.each do |msg| %>
                <li><%= msg %></li>
              <% end %>
            </ul>
          </div>
        <% end %>
        <div class="grid gap-3 md:grid-cols-2">
          <div>
            <%= f.label :title, class: "text-sm font-medium text-gray-700" %>
            <%= f.text_field :title, class: "mt-1 block w-full rounded-lg border border-gray-300 px-3 py-2 text-sm" %>
          </div>
          <div>
            <%= f.label :due_on, "Due date", class: "text-sm font-medium text-gray-700" %>
            <%= f.date_field :due_on, class: "mt-1 block w-full rounded-lg border border-gray-300 px-3 py-2 text-sm" %>
          </div>
        </div>
        <div>
          <%= f.label :description, class: "text-sm font-medium text-gray-700" %>
          <%= f.text_area :description, rows: 2, class: "mt-1 block w-full rounded-lg border border-gray-300 px-3 py-2 text-sm" %>
        </div>
        <div class="flex justify-end">
          <%= f.submit "Add task", class: button_classes(variant: :primary, size: :sm) %>
        </div>
      <% end %>
    <% end %>

    <%= card do %>
      <div class="flex items-center justify-between">
        <h2 class="text-lg font-semibold text-gray-900">Task list</h2>
        <span class="text-sm text-gray-500"><%= pluralize(@tasks.size, "task") %></span>
      </div>
      <div class="mt-4 space-y-4">
        <% if @tasks.any? %>
          <% @tasks.each do |task| %>
            <% done = task.status_done? %>
            <div class="rounded-xl border border-gray-200 p-4 <%= done ? 'bg-gray-50' : 'bg-white' %>">
              <div class="flex flex-wrap items-start justify-between gap-3">
                <div>
                  <p class="text-sm font-semibold <%= done ? 'text-gray-500 line-through' : 'text-gray-900' %>"><%= task.title %></p>
                  <% if task.description.present? %>
                    <p class="mt-1 text-xs text-gray-600"><%= task.description %></p>
                  <% end %>
                </div>
                <div class="flex items-center gap-2 text-xs">
                  <span class="rounded-full px-2 py-1 font-semibold <%= done ? 'bg-emerald-100 text-emerald-800' : 'bg-amber-100 text-amber-800' %>">
                    <%= task.status.humanize %>
                  </span>
                </div>
              </div>

              <div class="mt-4 grid gap-3 lg:grid-cols-3">
                <div class="lg:col-span-2">
                  <%= form_with model: task, url: task_path(task), method: :patch, class: "grid gap-3" do |f| %>
                    <div class="grid gap-3 sm:grid-cols-2">
                      <div>
                        <%= f.label :status, class: "text-xs font-medium text-gray-600" %>
                        <%= f.select :status,
                              Task.statuses.keys.map { |value| [ value.humanize, value ] },
                              {},
                              class: "mt-1 block w-full rounded-lg border border-gray-300 px-3 py-2 text-sm" %>
                      </div>
                      <div>
                        <%= f.label :due_on, "Due date", class: "text-xs font-medium text-gray-600" %>
                        <%= f.date_field :due_on, class: "mt-1 block w-full rounded-lg border border-gray-300 px-3 py-2 text-sm" %>
                      </div>
                    </div>
                    <div>
                      <%= f.label :notes, class: "text-xs font-medium text-gray-600" %>
                      <%= f.text_area :notes, rows: 2, class: "mt-1 block w-full rounded-lg border border-gray-300 px-3 py-2 text-sm" %>
                    </div>
                    <div class="flex flex-wrap items-center gap-2">
                      <%= f.submit "Save changes", class: button_classes(variant: :secondary, size: :sm) %>
                    </div>
                  <% end %>

                  <div class="mt-2 flex flex-wrap items-center gap-2">
                    <% unless done %>
                      <%= button_to "Mark complete", task_path(task),
                                    method: :patch,
                                    params: { task: { status: "done" } },
                                    class: button_classes(variant: :primary, size: :sm) %>
                    <% else %>
                      <%= button_to "Reopen", task_path(task),
                                    method: :patch,
                                    params: { task: { status: "todo" } },
                                    class: button_classes(variant: :outline, size: :sm) %>
                    <% end %>
                  </div>
                </div>
                <div>
                  <% unless done %>
                    <%= form_with model: task, url: postpone_task_path(task), method: :patch, class: "grid gap-2" do |f| %>
                      <%= f.label :due_on, "Postpone to", class: "text-xs font-medium text-gray-600" %>
                      <%= f.date_field :due_on, class: "block w-full rounded-lg border border-gray-300 px-3 py-2 text-sm" %>
                      <%= f.submit "Postpone", class: button_classes(variant: :outline, size: :sm) %>
                    <% end %>
                  <% else %>
                    <p class="text-xs text-gray-500">Completed <%= l(task.completed_at.to_date, format: :short) if task.completed_at %></p>
                  <% end %>
                </div>
              </div>
            </div>
          <% end %>
        <% else %>
          <div class="text-sm text-gray-500">No tasks scheduled for this day.</div>
        <% end %>
      </div>
    <% end %>
  </div>
<% end %>
